use super::{
    blockchain::Blockchain,
    mempool::Mempool,
    structure::{
        block::Block,
        consts::{HEADER_MERKLE_ROOT_SIZE, HEADER_PREVIOUS_BLOCK_HASH_SIZE},
    },
};
use crate::config::Config;
use colored::Colorize;
use nexium::{
    blockchain::{
        consts::SIGNATURE_SIZE, data_type::DataType, transaction::Transaction,
    },
    defaults::KEYPAIR_BIT_SIZE,
    gitlab::{GitlabClient, TokenType},
    rsa::KeyPair,
};
use std::path::Path;

const KEY_FILE: &str = ".nexiumlocal/private-key";
const CONFIG_PATH: &str = ".nexiumlocal/config.json";

pub async fn main() {
    let p = Path::new(CONFIG_PATH);
    let config = Config::from_file(p);

    let gitlab =
        GitlabClient::new(config.gitlab_token.clone(), TokenType::Classic);

    gitlab
        .check_token_async()
        .await
        .expect("Failed to check Gitlab token");

    let key = KeyPair::priv_from_file(
        KEY_FILE,
        &config.user_login,
        &config.key_password,
    )
    .expect("Failed to load private key from file");

    // let mut bc =
    //     Blockchain::init(gitlab).expect("Failed to initialize blockchain");
    // println!("blockchain size: {}", bc.size);

    // if bc.size == 0 {
    //     println!("Blockchain is empty, creating genesis block...");
    //     let t = Transaction::new(
    //         "GENESIS".as_bytes().to_vec(),
    //         0,
    //         "",
    //         DataType::Unknown,
    //         &key,
    //     )
    //     .expect("Failed to create transaction");
    //     // dbg!(&t);
    //     bc.add_transaction(t);
    //     return;
    // }

    // let b1 = match bc.read_block(0) {
    //     Ok(b) => b,
    //     Err(e) => {
    //         println!("Error getting block: {}", e);
    //         return;
    //     }
    // };
    // dbg!(&b1);
    // dbg!(hex::encode(&bc.last_hash));
    // return;

    // let b2 = match bc.get_block(&bc.last_hash.clone()) {
    //     Ok(b) => b,
    //     Err(e) => {
    //         println!("Error getting block: {}", e);
    //         return;
    //     }
    // };
    // dbg!(&b2);
    // dbg!(&b1 == &b2);
    // return;

    // let login1 = "william.valenduc";
    // let login2 = "jean.herail";
    // let balance = bc
    //     .get_user_balance(login1)
    //     .expect("Failed to get user balance");
    // println!("Balance: {} {}", login1, balance);

    // let balance = bc
    //     .get_user_balance(login2)
    //     .expect("Failed to get user balance");
    // println!("Balance: {} {}", login2, balance);
    // return;

    ///////////////
    let crypted = "0018346864217596927368065667457117149097126518747046748793357191940165789531783872715102171163605895003066131170546160218017219358889250697222684343670630938251566170423475421021204162493003986890342571512941643075368829356949402289454057046097460647722386989354336011919679089949823354587039232152769844674596224415520381718684357003550609664658543720368720050886184937664185274122180160627907989372130751053953376932458610769645250938720714841866186261536994189621037443960162668815789658445022325055683272474977085350435747620881154326099778514429885321990239562111354880972712504262795927778551813090431350960850700191163221433368657238316810768292961608329907886469871635288136206419350990665778163697576937985232403200379079186794331399203464199498855251425457361408815256713466648428910086609339936877813117469688819255912908081080078290012181153571545651951278652064979830112035899988970535453745680000257873670732982939846200856718410774314028619696126994647038952410023128305010603967560280086958150643597626939359250501782776809383620638225288309733081098516835510493136918601040570067720635350036728528629497581389750161427402218715916565078485034827703126624807202911867005368547419604607123803590692036233462600228412884002607791535077260785115882414059842293417443464285386034495722287390514922521666732288055063624921016479067692831813198564215552033593415395145516804047265422666128531608823863723777878927217746785367599589577585046372766757807694422338014726102588332559644651791387373917652783421442982602307802434355420134011741525754989750289460527475823349581348492223360040206056342688187599873430619589711004380051278159950133900671268179116180762394207320741016626911191495657113812505197834080821417258503470549961388232879805418516918775689792842646551271609298466692655486939346787444441558401059578359485814257838267595400061212389436086955903959749745268767766022720824090539775192779083562905118314618554271912563133845408593690215658635937754667611125794899153428893510152995440454162621010867985665612608969257206874544249935144935424394129491306141521394566415732951546857960214522537577575783388823411270095610755781046775032638352787160909772635956581134736396143489231286108109464925622777476903645318596156758857508505869080761117608568058939637232666936918526007404009108090628490315969315212476461014864696237872671873877837643506494571120693671766908264416689070069189441884220437830942201558728115615317500194438047945110755500509355657148455980831992328683711053255262010578406195245489977782629884011874041120418580325956841035212116809590319418226363988131424299039874281261272010388506660266168018095313475303541118241996991823420004275620282956419708009176658972318128154838438674707686299474503306094520958520181189568101219074836731571471181051771702611457076631961538575862739019040305322274596698389525719424893941816672952056402162910290300251668050874897408221807494390818573669148390291023571371826179820491246528374432828911314850544605160136153347718880535067171162771979619668557518774247276580359336570305335983595089559991195002354628559672545408360718722437893841252564653136904304386966311195939497816926996432230485288263582121880990116541746885078190043569510896282597286597626089749816177519432772353375921312900310990494281448127513820069866299209349186276007946187818589572895659738855265665160420190505972708602873505386066104469511057112808487764753807810442708303720010270860951026720418724372799701145521538225866373370483260249411585478828370006796268147583443907382255673165156723960671867811416239760856441292508332940653202265046577816475237750564318565996535055305582248152376076946470380536052466847618706566500467285771286420035244305104582577011401443429582750969929407123977432132439353522080103629797671928408098883700956980412591686404574675890094998434692457463867537157499095000156389009842349426363461732323412226102544862754440007955501423791936563688447864580833674499112984864593798540013819319577912753441211327747796963362635267726591543377665554000646508874253427996353720928825922008099119349403287994470604566458063404908679291004312598215731757741855226367935780319514349360438553526700464300161272276588708849634945790607433987522339010042082064054315419098346777586575354663855661802309397463870159644636231378209151165075700349868030470998265827529847537598276321427437550484464955336675146649861968518970650642993029133859811171078870266688487975249750348871479405721587417626522646246506888297368488635826330214633862154732876158182320834621401581815869438847397292456334233571768499941383184364117079686535164268842321867743633655621891353335691434401876066612801111011963113633267867892611146223720109965788474823728362432999637739330647182019507500155913018557374243543174447684785066967430748939050515604205636366432278710037614059040178033970263756331571162324526560325454930689612487024628869419856635200297695236401189905021984242000469964526532002632389128631690976083142645976242798932635344367116777589987062556231759634707079110448367193352522914013096533967496468902013751146112430353735961368901563439229998391232027147018637176711898286841652890020509687942018005598837592775924031090854364884127922688776972266556291848263712498703106268781145320325341120245280995583168969999206572635619273908421394020916299552985084292263024671134478706421161452687967936503725535716278773276018815494606546334000735706144089105403304601103036787858919716226995420056107168310252660147470140568404203615049750067522815549290957089035234470602437303641820025581435693140160194665702756957366063657770718425988932887952517285564462896448150927746317082590897946541697663834033366179957750411686330695688580555249385323689251056177564227820547589179950151904310374134864184608309855488272198971959534683661932372782502672397259997101182308087121049164642634676980516740887367714301084927394092161216476451780928274677469653212813569456292037340910217171828869637388008143852098460523709322357128356916282980740466432240744082329339243857873313141030489904228926601519025449788300367163044695934460416818370178415074194134003462745452454436254099495439944210763335542042571700572023044940289494611509100303601147773501442803737115494861796700065061439017583989651016354047875029029501633435747678220199026709811527687029784820760742693121706191247792368189234010952434012036523974938191837848470552310693640911842140384721855636118162838841409748680701647630493115406350830838993167489133873405787083476842006730126039946172090255845072325925367151179335202853777215126312602423352473223667721562044129171215965446576658423561897747126296659899963703626612321798987197886093789841772671367426509045369549322238087878375406460463819851416065776796506447984227067415670229369180116326245015869";
    let decrypted = key.decrypt_split(&crypted.to_string()).unwrap();
    println!("Decrypted:\n{}", decrypted);
    let r = json::parse(&decrypted).unwrap();
    println!("Parsed JSON: {}", r.to_string().green().bold());
    let trs: Vec<Transaction> = r
        .members()
        .map(|tr| serde_json::from_str(&tr.to_string()).unwrap())
        .collect();
    dbg!(&trs);
    return;
    ///////////////

    let tr = Transaction::new_classic(
        "jean.herail",
        100.65489 as f32,
        "",
        0,
        "william.valenduc",
        &key,
    );

    // let tr = Transaction::new_classic(
    //     "william.valenduc",
    //     50,
    //     "TEST_ERROR",
    //     0,
    //     "jean.herail",
    //     &key,
    // );

    // let tr = Transaction::new(
    //     "This is a test".as_bytes().to_vec(),
    //     0,
    //     "william.valenduc",
    //     DataType::Unknown,
    //     &key,
    // );

    let tr1 = match tr {
        Ok(t) => t,
        Err(e) => {
            println!("Error creating transaction: {}", e);
            return;
        }
    };
    // dbg!(&tr1);
    let json =
        serde_json::to_string(&tr1).expect("Failed to serialize transaction");
    // println!("Transaction: {}", json);
    let crypt = key.crypt_split(&json).expect("Failed to encrypt");
    println!("Crypt:\n{}", crypt);
    // bc.add_transaction(tr1);
}
